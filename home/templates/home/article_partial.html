{% load static wagtailcore_tags %}

{% if HTMX %}
<head>
<title>{{ page.title }}</title>
<meta name="description" content="{{ page.search_description }}">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "{{page.title}}",
  {% if page.search_description %}"description":"{{page.search_description}}",{% endif %}
  {% if page.image %}"image": "https://cdn.lunalux.io{{page.image.url}}",{% endif %}
  "author": {
    "@type": "Person",
    "name": "{{page.owner.get_full_name}}"
  },
  "name": "{{page.slug}}"
}
</head>
{% endif %}
    <header class="article-header">
    {% include_block page.header %}
    </header>

    <div class="row">

    <style>
        .content{
        max-width:inherit!important;
        }
        .content>.block-text{
        max-width:700px;
        }
    </style>

    <div id="article" class="article">

        <div class="title"><h1>{% include 'components/garden_status.html' with garden_status=page.garden_status %}{{ page.title }}</h1></div>

        {% if page.garden_status == "withering" %}
            <style>
                .alert {
                position: relative;
                top: 10;
                left: 0;
                width: auto;
                height: auto;
                padding: 10px;
                margin: 10px;
                line-height: 1.8;
                border-radius: 5px;
                cursor: hand;
                cursor: pointer;
                font-family: sans-serif;
                font-weight: 400;
                }

                .alertText {
                display: table;
                margin: 0 auto;
                text-align: center;
                font-size: 16px;
                }

                .warning {
                border: 1px solid rgb(164,99,42);
                color: rgb(164,99,42);
                }

                .alert .icon {
                    position: absolute;
                    top: -15px;
                    left: -15px;
                    font-size: 25px;
                    background-color: var(--body-bg);
                    border-radius: 50%;
                }
                .garden-status {
                    display:none;
                }
                @media screen and (max-width: 800px){
                    .alert .icon {
                        display:none;
                    }
                    .garden-status {
                        display:initial;
                    }
                }

                .withering-alert {
                    margin: 1rem;
                }
            </style>

            <div class="withering-alert">
                <a href="/garden" style="text-decoration:none">
                <div class="alert warning" style="margin: 0 auto; padding: 0 1rem; max-width: 700px;">
                    <span class="icon">üçÇ</span>
                    <p class=".alertText">This page is withering and is no longer maintained. It may become outdated as information and opinions change.</p>
                </div>
                </a>
            </div>
        {% endif %}

        <div id='article-content' class="content" hx-boost='true'>
            {% include_block page.body %}
        </div>

        <div class="byline">
        <div class="author">
            By <a href="/about" rel="author">{{page.owner.get_full_name}}</a>
        </div>
        {% if instance.show_timestamp %}
        <div class="publish">
            {{ instance.publish }}
        </div>
        {% endif %}
        </div>

    </div>


    {% if series %}
        <style>
        #sidebar{
            opacity:0 ;
            transition: opacity 300ms ease-in-out;
        }
        #sidebar.open {
            opacity:1;
        }
        </style>
        <div class="series-container" id="series-navbar" style="position:fixed; left:0;">
        <div id="sidebar" class="series sidebar">
            <div class="title"><a href=""><h1>{{series.title}}</h1></a></div>
            <div class="entries">
            {% for entries in series.articles %}
            {% for entry in entries.value %}
            <a href="{% pageurl entry %}?series={{series.id}}">
                <div class="entry" id="{% if entry.slug == page.slug %}active{% endif %}">{{entry.title}}</div>
            </a>
            {% endfor %}
            {% endfor %}
            </div>
        </div>
        </div>
        <script>
        let seriesContainer = document.getElementById("series-navbar")
        seriesContainer.style.marginLeft = (window.innerWidth-700)/2-280 + "px"

        window.addEventListener("resize",()=>{
            seriesContainer.style.marginLeft = (window.innerWidth-700)/2-280 + "px"
        })
        </script>
    {% endif %}


    </div>

    {% if series %}
    <div class="series-end" style="">
    <div style="max-width:700px; margin:0 auto;">
        <div class="title">
            <a href=""><h1>{{series.title}}</h1></a>
        </div>
        <div class="entries">
            {% for entries in series.articles %}
            {% for entry in entries.value %}
            <a href="{% pageurl entry %}?series={{series.id}}">
            <div class="entry" id="{% if entry.slug == page.slug %}active{% endif %}">{{entry.title}}</div>
            </a>
            {% endfor %}
            {% endfor %}
        </div>
        <spacer></spacer>
    </div>
    </div>
    {% endif %}


    {% if links or similar_objects  %}
    <div class="similar" hx-boost="true">
        <div class="single-col">
        <div class="section-header">
            <h1>Continue reading</h1>
        </div>

        {% if links %}
        <div class="container" style="margin-top: 1.8em;">
            <h2 title="Pages that link here">Backlinks</h2>
        </div>
        {% include 'blocks/lines_list.html' with pages=links include_images=True use_htmx=True%}
        {% endif %}

        {% if page.tags %}
        <div class="container" style="margin-top:1.8em;">
            <h2>Tags</h2>
            <ul class="tags">
                {% for tag in page.tags.all%}
                <a href="/tag/{{tag.slug}}"><li>{{tag.name}}</li></a>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if similar_objects %}
        <div class="container" style="margin-top: 1.8em;">
            <h2 title="Pages with similar tags">Recommended</h2>
        </div>
        {% include 'blocks/lines_list.html' with pages=similar_objects include_images=True use_htmx=True%}
        {% endif %}

    </div>
    {% endif %}

    {% comment %} Render extra scripts {% endcomment %}
    <script> // code highlight
        document.addEventListener("DOMContentLoaded", function(event) {
        var els = document.getElementsByTagName("pre")
        for (i=0; i<els.length; i++){
            block = els[i]
            hljs.highlightBlock(block)
        }
        })
    </script>


    <script> // katex
    renderMathInElement(document.body, {"delimiters": [
    {left: "$$", right: "$$", display: true},
    {left: "$", right: "$", display: false}
    ]});
    </script>

    <script>
        htmx.onLoad( function(e) {
            // set up heading anchors
            document.getElementById('article-content').querySelectorAll("h2, h3, h4, h5, h6").forEach((el)=>{
                el.setAttribute("id",el.textContent.slugify())

                beforeEl = document.createElement("a")
                beforeEl.setAttribute("href", "#" + el.textContent.slugify())
                beforeEl.setAttribute("class", "heading-anchor")
                beforeEl.innerHTML = '<i class="fas fa-link"></i>'

                el.insertBefore(beforeEl, el.firstChild)
            })

            // boost internal article links
            document.getElementById("article-content").querySelectorAll("a").forEach(el=>{
                if (el.href.includes(window.location.origin)){
                    el.setAttribute("hx-push-url", "true")
                    el.setAttribute("hx-swap", "innerHTML show:top")
                    el.setAttribute("hx-target", "#main")
                }
            })
        })
    </script>
